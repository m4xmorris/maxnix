name: "Nix Build"
on:
  push:
   branches:
    - main
  workflow_dispatch:
      
jobs:
  keyboard-pi:
    runs-on: [self-hosted, Linux]
    steps:
    - uses: actions/checkout@v4
    - name: Build image
      env:
        NIX_PATH: "nixpkgs=channel:nixos-23.11"
      run: |
        nix-build '<nixpkgs/nixos>'  \
          -A config.system.build.sdImage \
          -I nixos-config=./${{ github.job }}/configuration.nix \
          --argstr system aarch64-linux \
          --option sandbox false
    - name: Prepare image
      run : |
        sudo mv ./result/sd-image/*.img.zst ./result/sd-image/${{ github.job }}.img.zst
